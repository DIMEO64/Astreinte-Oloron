<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0ea5e9" />
  <title>Astreinte – Enregistreur d'heures</title>
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" href="/icons/icon-192.png" />
  <style>
    :root { --bg:#f8fafc; --card:#ffffff; --text:#0f172a; --muted:#475569; --brand:#0ea5e9; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--text); }
    .container { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .title { font-size: 28px; font-weight: 700; margin: 0 0 6px; }
    .subtitle { color: var(--muted); margin: 0 0 16px; }
    .row { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
    .btn { display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid #e2e8f0; background:#fff; cursor:pointer; }
    .btn.primary { background:var(--brand); color:#fff; border-color:var(--brand); }
    .btn:disabled { opacity:0.6; cursor:not-allowed; }
    .card { background:var(--card); border:1px solid #e2e8f0; border-radius:16px; box-shadow:0 1px 3px rgba(0,0,0,0.06); margin-top:16px; }
    .card .header { padding:16px 16px 0; }
    .card .body { padding:16px; }
    .grid { display:grid; gap:12px; }
    @media(min-width: 900px){ .grid.cols-3 { grid-template-columns: repeat(3, 1fr); } .grid.cols-4 { grid-template-columns: repeat(4, 1fr);} }
    label { display:block; font-size:13px; color:#334155; margin-bottom:6px; }
    input, textarea, select { width:100%; padding:10px 12px; border:1px solid #e2e8f0; border-radius:10px; background:#fff; }
    textarea { min-height: 72px; }
    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding:8px 10px; border-top:1px solid #e5e7eb; vertical-align: top; }
    thead th { background:#f1f5f9; font-weight:600; }
    .pill { border:1px solid #e2e8f0; border-radius:14px; padding:6px 10px; background:#fff; }
    .muted { color:#64748b; font-size:12px; }
    .dialog-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.4); display:flex; align-items:center; justify-content:center; }
    .dialog { width:min(520px, 92%); background:#fff; border-radius:16px; padding:16px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="row" style="justify-content: space-between; align-items: flex-end;">
      <div>
        <h1 class="title">Astreinte – Enregistreur d'heures</h1>
        <p class="subtitle">Un clic pour horodater : départ domicile → arrivée travail → départ travail. Données locales. Option : géolocalisation. Installable.</p>
      </div>
      <div class="row">
        <button id="btnCsv" class="btn">CSV</button>
        <div class="row pill">
          <label for="month" style="margin:0;">Mois</label>
          <input id="month" type="month" style="height:36px">
          <button id="btnPdf" class="btn">PDF (mois choisi)</button>
        </div>
        <button id="btnNew" class="btn">Nouveau</button>
        <button id="btnInstall" class="btn primary">Installer l’app</button>
      </div>
    </div>

    <div class="card">
      <div class="header">
        <h3 style="margin:0 0 4px;">Enregistrement actif</h3>
        <p class="muted">Utilise le <b>bouton unique</b> ou les boutons détaillés. Active la géolocalisation si souhaité.</p>
      </div>
      <div class="body grid cols-4">
        <div>
          <label for="date">Date</label>
          <input id="date" type="date">
        </div>
        <div class="row" style="align-items:center; gap:8px;">
          <input id="geoToggle" type="checkbox">
          <label for="geoToggle" style="margin:0;">Géolocalisation</label>
        </div>
        <div class="row" style="grid-column: span 2;">
          <button id="btnOne" class="btn primary" style="flex:1;">Action</button>
        </div>
      </div>
      <div class="body row">
        <button id="btnDH" class="btn" style="flex:1;">Départ domicile</button>
        <button id="btnAW" class="btn" style="flex:1;">Arrivée travail</button>
        <button id="btnDW" class="btn" style="flex:1;">Départ travail</button>
        <button id="btnReset" class="btn">Réinitialiser</button>
      </div>
      <div class="body grid cols-3">
        <div>
          <label>Départ domicile</label>
          <input id="inpDH" type="datetime-local">
          <div class="muted" id="lblDH">—</div>
        </div>
        <div>
          <label>Arrivée travail</label>
          <input id="inpAW" type="datetime-local">
          <div class="muted" id="lblAW">—</div>
        </div>
        <div>
          <label>Départ travail</label>
          <input id="inpDW" type="datetime-local">
          <div class="muted" id="lblDW">—</div>
        </div>
      </div>
      <div class="body grid cols-3">
        <div class="pill"><div class="muted">Trajet</div><div id="durCommute" style="font-weight:600; font-size:18px;">0h00</div></div>
        <div class="pill"><div class="muted">Sur site</div><div id="durOnsite" style="font-weight:600; font-size:18px;">0h00</div></div>
        <div class="pill"><div class="muted">Total</div><div id="durTotal" style="font-weight:600; font-size:18px;">0h00</div></div>
      </div>
      <div class="body">
        <label for="note">Note</label>
        <textarea id="note" placeholder="Ex: Appel UHCD, patient X, intervention 30 min…"></textarea>
      </div>
    </div>

    <div class="card">
      <div class="header">
        <h3 style="margin:0 0 4px;">Historique</h3>
        <p class="muted">Filtrer, exporter CSV/PDF. Les données restent dans votre navigateur.</p>
      </div>
      <div class="body row">
        <div>
          <label for="filterDate">Filtrer par date</label>
          <input id="filterDate" type="date">
        </div>
        <button id="btnClearFilter" class="btn">Effacer le filtre</button>
        <div style="flex:1"></div>
        <button id="btnCsvSel" class="btn">CSV (sélection)</button>
      </div>
      <div class="body" style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Date</th><th>Départ domicile</th><th>Arrivée travail</th><th>Départ travail</th>
              <th>Trajet</th><th>Sur site</th><th>Total</th><th>Note</th><th></th>
            </tr>
          </thead>
          <tbody id="tblBody"></tbody>
        </table>
      </div>
      <div class="body muted" style="text-align:center;">LocalStorage • CSV & PDF mensuel • Géoloc optionnelle • PWA installable — v2.0</div>
    </div>
  </div>

  <!-- Simple dialog fallback -->
  <div id="dlg" style="display:none;" class="dialog-backdrop" role="dialog" aria-modal="true">
    <div class="dialog">
      <h3 style="margin:0 0 10px;">Installer sur Android</h3>
      <p class="muted">Si le bouton n’affiche pas la fenêtre d’installation automatique :</p>
      <ol>
        <li>Ouvre le menu ⋮ de Chrome.</li>
        <li>Choisis <b>Ajouter à l’écran d’accueil</b> ou <b>Installer l’application</b>.</li>
        <li>Confirme — l’appli s’installe comme une app native.</li>
      </ol>
      <div class="row" style="justify-content:flex-end;"><button id="dlgClose" class="btn">OK</button></div>
    </div>
  </div>

  <!-- Libs -->
  <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/jspdf-autotable@3.8.1/dist/jspdf.plugin.autotable.js"></script>

  <script>
  // Storage
  const STORAGE_KEY = "astreinte_records_pwa_v1";
  const $ = (id) => document.getElementById(id);
  const todayISODate = () => new Date().toISOString().slice(0,10);
  const monthKey = (iso) => iso.slice(0,7);
  const fmtHM = (ms) => {
    const h = Math.floor(ms/3600000), m = Math.round((ms%3600000)/60000);
    return h + "h" + String(m).padStart(2,"0");
  };
  const fmtDT = (iso) => iso ? new Date(iso).toLocaleString("fr-FR") : "—";
  const toMin = (ms) => Math.round(ms/60000);

  function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY))||[] }catch{ return [] } }
  function save(list){ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }

  let records = load();
  let activeId = records.find(r=>r.dateISO===todayISODate())?.id || null;
  let geoEnabled = false;
  let deferredPrompt = null;
  let isStandalone = window.matchMedia('(display-mode: standalone)').matches || (navigator.standalone === true);

  async function getGeo(){
    if (!geoEnabled || !('geolocation' in navigator)) return undefined;
    return new Promise(res => {
      navigator.geolocation.getCurrentPosition(
        p => res({ lat:p.coords.latitude, lng:p.coords.longitude, acc:p.coords.accuracy }),
        _ => res(undefined),
        { enableHighAccuracy:true, maximumAge:10000, timeout:8000 }
      );
    });
  }

  function newRecord(dateISO=todayISODate()){ return { id: crypto.randomUUID(), dateISO }; }
  function compute(r){
    const t1 = r.depart_home ? new Date(r.depart_home).getTime() : 0;
    const t2 = r.arrive_work ? new Date(r.arrive_work).getTime() : 0;
    const t3 = r.depart_work ? new Date(r.depart_work).getTime() : 0;
    const commute = t1 && t2 && t2>t1 ? t2-t1 : 0;
    const onSite = t2 && t3 && t3>t2 ? t3-t2 : 0;
    const total = commute + onSite;
    return { commute, onSite, total };
  }

  function getActive(){ return records.find(r=>r.id===activeId) || null; }
  function update(id, patch){
    records = records.map(r => r.id===id ? {...r, ...patch} : r);
    save(records);
    render();
  }

  async function stamp(key){
    const a = getActive(); if(!a) return;
    const now = new Date().toISOString();
    const geo = await getGeo();
    const patch = { [key]: now, dateISO: now.slice(0,10) };
    if(key==='depart_home') patch.depart_home_geo = geo;
    if(key==='arrive_work') patch.arrive_work_geo = geo;
    if(key==='depart_work') patch.depart_work_geo = geo;
    update(a.id, patch);
  }

  function nextAction(){
    const a = getActive();
    if(!a) return { key:null, label:'Créer une entrée' };
    if(!a.depart_home) return { key:'depart_home', label:'Départ domicile' };
    if(!a.arrive_work) return { key:'arrive_work', label:'Arrivée travail' };
    if(!a.depart_work) return { key:'depart_work', label:'Départ travail' };
    return { key:null, label:'Nouvelle entrée' };
  }

  function addRecord(){
    const r = newRecord();
    records = [r, ...records];
    activeId = r.id;
    save(records);
    render();
  }

  function delRecord(id){
    records = records.filter(r=>r.id!==id);
    if(activeId===id) activeId = null;
    save(records);
    render();
  }

  function setActive(id){ activeId = id; render(); }
  function resetStamps(){
    const a = getActive(); if(!a) return;
    update(a.id, { depart_home:undefined, arrive_work:undefined, depart_work:undefined, depart_home_geo:undefined, arrive_work_geo:undefined, depart_work_geo:undefined });
  }

  function render(){
    const a = getActive();
    // active section
    $('date').value = a?.dateISO || todayISODate();
    $('inpDH').value = a?.depart_home ? a.depart_home.slice(0,16) : '';
    $('inpAW').value = a?.arrive_work ? a.arrive_work.slice(0,16) : '';
    $('inpDW').value = a?.depart_work ? a.depart_work.slice(0,16) : '';
    $('note').value = a?.note || '';

    $('lblDH').textContent = a?.depart_home ? (fmtDT(a.depart_home) + (a.depart_home_geo? ` • ${a.depart_home_geo.lat.toFixed(5)},${a.depart_home_geo.lng.toFixed(5)} (±${Math.round(a.depart_home_geo.acc||0)}m)` : '')) : '—';
    $('lblAW').textContent = a?.arrive_work ? (fmtDT(a.arrive_work) + (a.arrive_work_geo? ` • ${a.arrive_work_geo.lat.toFixed(5)},${a.arrive_work_geo.lng.toFixed(5)} (±${Math.round(a.arrive_work_geo.acc||0)}m)` : '')) : '—';
    $('lblDW').textContent = a?.depart_work ? (fmtDT(a.depart_work) + (a.depart_work_geo? ` • ${a.depart_work_geo.lat.toFixed(5)},${a.depart_work_geo.lng.toFixed(5)} (±${Math.round(a.depart_work_geo.acc||0)}m)` : '')) : '—';

    const d = a ? compute(a) : {commute:0, onSite:0, total:0};
    $('durCommute').textContent = fmtHM(d.commute);
    $('durOnsite').textContent = fmtHM(d.onSite);
    $('durTotal').textContent = fmtHM(d.total);

    const step = nextAction(); $('btnOne').textContent = step.label;

    // table
    const filt = $('filterDate').value;
    const list = filt ? records.filter(r=>r.dateISO===filt) : records;
    const tb = $('tblBody'); tb.innerHTML = '';
    list.forEach(r => {
      const dd = compute(r);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.dateISO}</td>
        <td>${r.depart_home?fmtDT(r.depart_home):''}${r.depart_home_geo? `<div class="muted">📍 ${r.depart_home_geo.lat.toFixed(5)},${r.depart_home_geo.lng.toFixed(5)} (±${Math.round(r.depart_home_geo.acc||0)}m)</div>`:''}</td>
        <td>${r.arrive_work?fmtDT(r.arrive_work):''}${r.arrive_work_geo? `<div class="muted">📍 ${r.arrive_work_geo.lat.toFixed(5)},${r.arrive_work_geo.lng.toFixed(5)} (±${Math.round(r.arrive_work_geo.acc||0)}m)</div>`:''}</td>
        <td>${r.depart_work?fmtDT(r.depart_work):''}${r.depart_work_geo? `<div class="muted">📍 ${r.depart_work_geo.lat.toFixed(5)},${r.depart_work_geo.lng.toFixed(5)} (±${Math.round(r.depart_work_geo.acc||0)}m)</div>`:''}</td>
        <td>${fmtHM(dd.commute)}</td>
        <td>${fmtHM(dd.onSite)}</td>
        <td><b>${fmtHM(dd.total)}</b></td>
        <td style="max-width:22rem; white-space:pre-wrap;">${r.note||''}</td>
        <td><button class="btn" data-act="activate" data-id="${r.id}">${r.id===activeId?'Actif':'Activer'}</button> <button class="btn" data-act="delete" data-id="${r.id}">Supprimer</button></td>
      `;
      tb.appendChild(tr);
    });
  }

  // CSV
  function csvOf(rows){
    const headers = ["ID","Date","Départ domicile","Arrivée travail","Départ travail","Durée trajet (min)","Durée sur site (min)","Durée totale (min)","Note","Geo départ (lat,lng,±m)","Geo arrivée (lat,lng,±m)","Geo départ travail (lat,lng,±m)"];
    const lines = rows.map(r => {
      const d = compute(r);
      const g1 = r.depart_home_geo? `${r.depart_home_geo.lat},${r.depart_home_geo.lng},±${Math.round(r.depart_home_geo.acc||0)}`:"";
      const g2 = r.arrive_work_geo? `${r.arrive_work_geo.lat},${r.arrive_work_geo.lng},±${Math.round(r.arrive_work_geo.acc||0)}`:"";
      const g3 = r.depart_work_geo? `${r.depart_work_geo.lat},${r.depart_work_geo.lng},±${Math.round(r.depart_work_geo.acc||0)}`:"";
      return [r.id, r.dateISO, r.depart_home?new Date(r.depart_home).toLocaleString('fr-FR'):'', r.arrive_work?new Date(r.arrive_work).toLocaleString('fr-FR'):'', r.depart_work?new Date(r.depart_work).toLocaleString('fr-FR'):'', toMin(d.commute), toMin(d.onSite), toMin(d.total), (r.note||'').replaceAll('\n',' '), g1, g2, g3].join(';');
    });
    return [headers.join(';'), ...lines].join('\n');
  }
  function downloadText(name, text, mime='text/plain;charset=utf-8'){
    const blob = new Blob(["\ufeff"+text], {type:mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  // PDF per month
  function exportPDFForMonth(key){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'pt', format:'a4' });
    const margin = 36;
    const pageW = doc.internal.pageSize.getWidth();

    const rows = records.filter(r => monthKey(r.dateISO)===key).sort((a,b)=>a.dateISO.localeCompare(b.dateISO));
    let totalCommute=0, totalOnSite=0, totalAll=0;
    const body = rows.map(r => {
      const d = compute(r);
      totalCommute+=d.commute; totalOnSite+=d.onSite; totalAll+=d.total;
      const t = (iso)=> iso? new Date(iso).toLocaleTimeString('fr-FR',{hour:'2-digit', minute:'2-digit'}):'';
      return [ new Date(r.dateISO).toLocaleDateString('fr-FR'), t(r.depart_home), t(r.arrive_work), t(r.depart_work), toMin(d.commute), toMin(d.onSite), toMin(d.total), r.note||'' ];
    });

    const [y,m] = key.split('-');
    doc.setFontSize(14);
    doc.text(`Astreintes – Récapitulatif mensuel ${m}/${y}`, margin, 40);
    doc.setFontSize(10);
    doc.text('Établissement : Centre Hospitalier d’Oloron (exemple)', margin, 58);

    doc.autoTable({
      head: [['Date','Départ domicile','Arrivée travail','Départ travail','Trajet (min)','Sur site (min)','Total (min)','Note']],
      body,
      startY: 74,
      styles: { fontSize: 9, cellPadding: 4 },
      headStyles: { fillColor: [240,240,240] },
      margin: { left: margin, right: margin },
      tableWidth: pageW - margin*2,
      columnStyles: { 7: { cellWidth: 180 } }
    });

    const yAfter = doc.lastAutoTable.finalY + 14;
    doc.setFontSize(11);
    doc.text(`Total trajet: ${toMin(totalCommute)} min  |  Sur site: ${toMin(totalOnSite)} min  |  Total: ${toMin(totalAll)} min`, margin, yAfter);
    doc.save(`astreintes_${key}.pdf`);
  }

  // Install/PWA
  window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; });
  window.addEventListener('appinstalled', () => { deferredPrompt = null; isStandalone = true; render(); });

  // Register SW
  if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js').catch(()=>{});

  // Init month selector
  const now = new Date(); const mk = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  $('month').value = mk;

  // Handlers
  $('btnNew').onclick = addRecord;
  $('btnCsv').onclick = () => downloadText(`astreintes_${todayISODate()}.csv`, csvOf(records), 'text/csv;charset=utf-8');
  $('btnCsvSel').onclick = () => {
    const filt = $('filterDate').value;
    const list = filt ? records.filter(r=>r.dateISO===filt) : records;
    downloadText(`astreintes_selection_${todayISODate()}.csv`, csvOf(list), 'text/csv;charset=utf-8');
  };
  $('btnPdf').onclick = () => exportPDFForMonth($('month').value);
  $('btnInstall').onclick = async () => {
    if (isStandalone) return;
    if (deferredPrompt) {
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
    } else {
      // show fallback dialog
      $('dlg').style.display = 'flex';
    }
  };
  $('dlgClose').onclick = () => $('dlg').style.display = 'none';

  $('btnDH').onclick = () => stamp('depart_home');
  $('btnAW').onclick = () => stamp('arrive_work');
  $('btnDW').onclick = () => stamp('depart_work');
  $('btnReset').onclick = resetStamps;
  $('geoToggle').onchange = (e) => geoEnabled = e.target.checked;

  $('date').onchange = (e) => { const a = getActive(); if(a) update(a.id, { dateISO: e.target.value }); };
  $('inpDH').onchange = (e) => { const a = getActive(); if(a) update(a.id, { depart_home: e.target.value? new Date(e.target.value).toISOString(): undefined }); };
  $('inpAW').onchange = (e) => { const a = getActive(); if(a) update(a.id, { arrive_work: e.target.value? new Date(e.target.value).toISOString(): undefined }); };
  $('inpDW').onchange = (e) => { const a = getActive(); if(a) update(a.id, { depart_work: e.target.value? new Date(e.target.value).toISOString(): undefined }); };
  $('note').oninput  = (e) => { const a = getActive(); if(a) update(a.id, { note: e.target.value }); };

  $('filterDate').onchange = render;
  $('btnClearFilter').onclick = () => { $('filterDate').value=''; render(); };

  $('btnOne').onclick = async () => {
    const step = nextAction();
    if (!getActive() || step.key===null) addRecord();
    else await stamp(step.key);
  };

  // Ensure one active record today
  if (!activeId) { addRecord(); } else { render(); }
  </script>
</body>
</html>